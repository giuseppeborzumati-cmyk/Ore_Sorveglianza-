<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Sorveglianze Scolastiche</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Stili personalizzati per la stampa (PDF/Report) */
        @media print {
            body {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact;
            }
            #app-container, #report-container {
                box-shadow: none !important;
                border: none !important;
            }
            .no-print {
                display: none !important;
            }
            .report-table th, .report-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
        }
    </style>
    <!-- Carica Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili globali per l'ambiente Canvas (obbligatorie)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback for local testing */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configurazione Firebase fornita dall'utente (per verifica connessione)
        const userFirebaseConfig = {
            apiKey: "AIzaSyCgVfSzyZi1jIOXvGqe17bsuaVbBr9bW8A",
            authDomain: "oresorveglianza.firebaseapp.com",
            projectId: "oresorveglianza",
            storageBucket: "oresorveglianza.firebasestorage.app",
            messagingSenderId: "55401666581",
            appId: "1:55401666581:web:c1f303fc1607241df4561c",
            measurementId: "G-GV2ERZ13NG"
        };
        
        // Uso la configurazione utente per la verifica di connessione
        const config = initialAuthToken ? firebaseConfig : userFirebaseConfig; 

        // Inizializzazione Firebase e verifica connessione
        window.app = initializeApp(config);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        
        // Imposta livello di log per Firestore (consigliato)
        setLogLevel('Debug');

        // Funzione per verificare lo stato di connessione
        const checkConnection = async () => {
            const statusElement = document.getElementById('firebase-status');
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    // Tenta di accedere con la configurazione utente (anonimo)
                    await signInAnonymously(window.auth);
                }
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        statusElement.textContent = "Connesso: OK";
                        statusElement.classList.remove('bg-red-500', 'bg-yellow-500');
                        statusElement.classList.add('bg-green-500');
                        window.isFirebaseReady = true;
                    } else {
                        statusElement.textContent = "Connessione: In attesa di autenticazione...";
                        statusElement.classList.remove('bg-green-500', 'bg-red-500');
                        statusElement.classList.add('bg-yellow-500');
                    }
                });
            } catch (error) {
                console.error("Errore di connessione o autenticazione Firebase:", error);
                statusElement.textContent = "Errore Connessione: FALLITA";
                statusElement.classList.remove('bg-green-500', 'bg-yellow-500');
                statusElement.classList.add('bg-red-500');
            }
        };

        window.addEventListener('load', checkConnection);
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Schermata di Login -->
    <div id="login-screen" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl transition-all duration-500">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Sistema Sorveglianze</h1>
        <p class="text-sm text-gray-500 mb-8 text-center">Accedi per avviare l'analisi avanzata.</p>
        <div id="firebase-status" class="mb-6 p-3 text-center text-sm font-semibold text-white rounded-lg bg-yellow-500 transition-colors duration-300">
            Connessione: In corso...
        </div>
        <input type="password" id="password-input" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="Inserisci la password di accesso">
        <button id="login-button" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-md">
            Accedi
        </button>
        <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">Password errata. Riprova.</p>
    </div>

    <!-- Contenitore Principale dell'Applicazione -->
    <div id="app-container" class="hidden w-full max-w-7xl bg-white p-8 rounded-xl shadow-2xl transition-all duration-500">
        <h1 class="text-3xl font-extrabold text-blue-600 mb-6 border-b pb-2">Assegnazione Sorveglianze Dada</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Pannello di Controllo -->
            <div class="md:col-span-1 p-6 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Controlli e Stato</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stato Operativo:</label>
                    <div id="process-status" class="p-3 bg-red-100 text-red-700 font-semibold rounded-lg text-sm">
                        Pronto per l'avvio.
                    </div>
                </div>

                <div class="mb-6">
                    <label for="progress-bar" class="block text-sm font-medium text-gray-700 mb-2">Avanzamento Calcolo:</label>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <button id="run-logic-button" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition-colors duration-300 shadow-lg disabled:bg-gray-400" onclick="runAnalysis()">
                    Avvia Calcolo Sorveglianze
                </button>
            </div>
            
            <!-- Risultato Analisi (Report) -->
            <div class="md:col-span-2 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Risultati e Reportistica</h2>
                
                <div id="report-summary" class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="total-assignments">0</div>
                        <div class="text-sm text-gray-500">Sorveglianze Totali Assegnate</div>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="unique-teachers">0</div>
                        <div class="text-sm text-gray-500">Docenti Coinvolti</div>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-4 no-print">
                    <button id="download-pdf-button" onclick="generatePDFReport()" class="flex-1 bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-300 shadow-md flex items-center justify-center disabled:bg-gray-400">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Scarica Report PDF
                    </button>
                    <button id="download-excel-button" onclick="generateCSVReport()" class="flex-1 bg-teal-500 text-white p-3 rounded-lg font-semibold hover:bg-teal-600 transition-colors duration-300 shadow-md flex items-center justify-center disabled:bg-gray-400">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Scarica CSV (Excel)
                    </button>
                </div>

                <div id="report-container" class="max-h-[60vh] overflow-y-auto bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300">
                    <p class="text-gray-500 text-center italic">I risultati dell'analisi appariranno qui dopo l'avvio del calcolo.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SEZIONE CONSTANTI E DATI PRE-CARICATI (HARDCODED) ---

        // Password 'cifrata' (in realtà un semplice hash per non mostrarla in chiaro)
        // La password è 'sorveglianza2025' -> HASH MD5 Semplice (client-side)
        const PASSPHRASE = 'b308e752985392576b2511059f20e8a7'; 
        
        // Dati Tabella Orari forniti dall'utente (Rappresentazione RAW dell'Excel)
        const RAW_TIMETABLE_DATA = `
        LUNEDI'							MARTEDI'							MERCOLEDI'							GIOVEDI'							VENERDI'						
        8:00	8:50	9:55	10:50	11:50	13:00	13:50	8:00	8:50	9:55	10:50	11:50	13:00	13:50	8:00	8:50	9:55	10:50	11:50	13:00	13:50	8:00	8:50	9:55	10:50	11:50	13:00	13:50	8:00	8:50	9:55	10:50	11:50	13:00	13:50
        ABBIATI CHIARA				5J	3T	2J	4J		5J	3J		1J	2J	3T		4J	3J							4J	5J	2J	3T	1J						3J	1J	
        ARCARA MATTEO																							1S	3I	5S		4I	2S	1B							
        ARGENTINA COSIMO		5J	5D	D	3J	3J							4J	2J		5D	5J		4J				5J	5J	3J					4J	4J	3J	5J		2J	
        BACCO ALESSANDRA					1D	1D					2DN	2DN	1D	1D		3D	3D	X	X	3P	3P		2DN	2DN						3D	3D		1D	3P	3P	
        BAJ SARAH		2A		1A		2P	2N	1P												1A	1J									2N	2A	1J		2P	1P	
        BAÙ GIORGIA		2DN	2S		1N		1D	1V	1V	1D	1N								1T	2DN	1N	1D			2DN	D	1D	1V						1P	1S	
        BELLOTTI GABRIELE		4N	D	3P					D	D	D		4P	5P							4P	3P	4N		4P	4P	4N	4N		4P	4P	5P				
        BENFENATI ANDREA					2T	3D	4L	5D				3N		5L			5D	3D	2T		5L	3N	2T	5P	4L	3D	3N	1J		5L	4L	5D				
        BIFFI ELENA					1V	1V	1B	1N																	1V		1P	1A	1D							
        BORZUMATI GIUSEPPE		2L	3I	1B	1B	5L	3L		5I	3I						2I		1A	1A	1B					2I	2L	5I	5L						1A	3L	
        BOTTA RAFFAELLA		5A	5A		3A	4A	5S	1S				5S	1S	2S				5S	5S		4A	4A	5S	5S	2S									5A	3A	
        BOTTON CRISTINA				2T	2A	1J	2S					1S	2S	1T		1J	2T			2J	1V				1A	2A	1T	1S					2J	1V	1A	
        BRUNETTA VIVIANA									D	D	D																						D	D		
        BUCOLO ROSARIO																																				
        CALABRESE M.			2N	2P	2P								3L	3L		1A	1A		1B	2P	3I						2N	2N	1A		3L	3I	3I	1B	1B	
        CALIFANO CARMELA		3J	3J						1T		4J					1V	D	3J	3J			4J			D		4J	1T		3J	D	D	1V	4J	4J	
        CANNELLA CHIARA			2D	2N					1D	1B								2D	1N	1P	1A	2P														
        CAPODICI FRANCESCO		1P		2D	2S		2J	2P					2N	1P	1D				1D	1D	2P	2S			2J	2N	2D	2T			2N	2P	1P	2T	2D	
        CAPUTO SERENA			4L	5D	3L	1I	1I		1I		4L					X	X	3L	3L				4L	4L	1I	1I		5D				3L	5D			
        CARPINO GIACOMO					D	3N	5N	5N				D	D	3N				5N	5N	3N	3N					3N	D	5N				3N	3N	5N	5N	
        CASALINO ANGELO		1J	2J	D												2J	1J	D																		
        CASIRAGHI ANDREA		3D	3D		5D	5D					3D	3D	5D					1D		3D	3D	5D	3D	3D	3D	5D	5D	1D		5D	5D	3D	3D	5D	1D	
        CASTOLDI VALERIA									5P	5P		1T				5P	5P	1T												5P	5P	1T	1T			
        CATALDO FEDERICA																2A	2A		4A	4A													2A	4A	4A	
        CAVALIERATOS ANGELA					D	1B	2A	1A		1A		D	1B	2A					D	2A	1B	1A														
        CAVICCHIONI CRISTINA		1S	2L	2I	1T														1T	2L	2I	1S								1T	2I			2L	1S	
        CIMINO SALVATORE		3N	2D	2N					1P	1P	2P		2D	2D		3N	1D	2N	2N	1P			D	D	2P	2P								1D	1D	
        CIMMINO MARIO						2S	1J	2J	2J	2S	2T		1T	1S						2T	1T	1J	1T	2S		1S	1J	2J						1S	2T	
        CIONCI SIMONA		1B	1B	D	D	D		1T								1T	1B	1B												1B	1B					
        CITTERIO MAURIZIO		1L							5L	5L	2L	1L	1L		X	5L	2L	1L	1L				2L	2L			5L		5L							
        COGLIATI LUIGI					3P	4N	4N		5N	4N	4N		3P	3P		3P	3P	4N	4N	D			3P	3P						4N	4N		5N			
        COLOMBO GIULIANA		2S	4N	2J	3N		1S		1S	2J	2S	2T				2S	2S	2T		1S	1S		2J	2J	1N							2T	2T			
        COLOMBO RUGGERO		5I	5I	1I	1I					1I	1I	1I	5I										1I	1I	5I											
        COLZANI BARBARA		5P	2S	3L	4I	2J			1V		5S	2S				4I	5S	5P					4I	5P	3L					3L	D		2S	5S		
        COMI LUCA									5D	5D	5D	5D	3D	3D						5D	5D	3D														
        CONTI DAMIANA												5A	5A	3A				3A	3A		5A	5A	3A	3A	5A											
        CORTI CHIARA				4P	4P	3P	3P	5P	4N	4P	5P	5P	5N	5N		4N	4N	4P		5N			5N	3N	3N	5P	3P							4N	3N	
        CORVI LAURA		4L		1D	1D	4I	4I	2A	1D		1P						4I	2D	4L	4L		2A				1N	2A	1P	1P	2D	2D	1N	1N			
        COTRONEO SIMONA		5S	5S	2S	X				3T	3T	X	X				5S		3T	1S	2S				3T		5S	5S			1S	X	X	X			
        CRESCENTI SALVATORE						1T	5L	4N			3N		1J	4J						3T	1I	5NT				1V	2T	4L	1N	2I	5J		4T	2J	3J	
        CRIPPA ELENA		X	X		5J	5J			X	X	5J	5J	X	X		X	X						X	X						X	X			5J	5J	
        CUCCHIARA ROSALINDA		3I	4L		2I	2I		X		5I	3I	3I				5I	2I	4I					3I	4I	1I	1I				5I	5I	4I	4I	2I		
        CURIA CLELIA				1T		2T	1V	5S					2T	5S						1V	2T	1T				1T	1V	5S								
        D'AMICO ROMINA									5S	5S	2J	2J						2J	2J		5S	5S								2J	2J	5S	5S			
        DE BENEDETTI SERGIO		1A	1A	1V	4A				5A	5A	1A	1V				4A	4A	1L	1L				1A	2L		5A				4A	1V	1V				
        DE FABRIS ANNALISA			1S	5S		3T		5T					5S	4T				1S	4T	5T	2S	3T				4T	2S	5T				2S	1S	3T	5S	
        DELLA TORRE ANNA			4A	4A		5A	5A		3A	3A	4A	4A				3A	3A	5A	5A								4A	4A			5A	5A	3A	3A		
        DI DIA VITO						2N	2D	2D		1B	2A	2A	1A	1A			2P	2P	1N		1A	2P				2D	1B	1B		1N	1N	2A		2N	2N	
        DI STASIO MARIA GRAZIA																																				
        ESPOSITO ERIKA				5P	5P	3P	3P				5P	5P	3P	3P					5P	5P	5P	5P	3P	3P								3P	3P	5P	5P	
        FILIPPA FRANCESCA			4A	4A		5A	5A		3A	3A	4A	4A				3A	3A	5A	5A								4A	4A			5A	5A	3A	3A		
        FIRRINCIELI GIOVANNI		1D	1D	3D	3D		1N		3D	3D	1D	1D	1N			1N	1N		3D	D								3D	1D	1D	1D					
        FRAIESE ALESSIA		4T	1J	1J			4A	4A					4T	4A		4T	4T						1J	1J	4A		4T	4T		1J	1J	4A	4A			
        FRATTA DONATO						1S	X				X									X				X							1S	X				
        GALBIATI ALESSANDRA					4J	4J	5T	3J					5T	5T				4T	3T	4J	5J	5J				3J	3J			3T	3T	5J		4T	4T	
        GAVAZZI IRIS											4I	4I	2L	1N													1N	4I				2L	2L		4I	
        GHALI SAMIRA		1N	1N	1B	1B											1P	1P	1A	1A				1D	1D												
        GIARDINA GIUSI		5L	5L	3I		3L						3L	3I	3I			1I	1I	5L	5L	3L				3I	5L	3L	3L						1I	3I	
        GIUNTA CALOGERO																		4L	4I	1I	1L									4L	4I	1L	1I			
        GRIFÒ VALENTINA					5T	5T	2T	4T	5T	4T	4T		3T					5T	5T	4T	3T	2T	3T	5T						4T		3T	3T			
        IAVARONE LAURA			X	X		2D	3D	1D	1B	D						D	D			1N	1D	1B					3D	2D				1D	D	D	1N	
        IOP ELENA		1T	1T	2J					1J	1J	1A	1V				2P	1T	1J		3P			2DN		1T	1B		2A		4A	1P	3L	1J			
        LA MATTINA ELENA		X	5NT	5NT					X	5NT		X				X	X	X	X	X			X	X	5NT	5NT				X	X	5NT				
        LA PAGLIA DOMINGO							5N	5N	3N	3N	5N	5N	5N	5N				5N	5N	3N	3N			3N	3N							3N	3N	5N	5N	
        LILLIU DANIELA		4P	1P		1N	5N	2P	3P	2P		3P	3P	1P						2P	4N	5N	4P	4P	5N	4N								X	1P	4N	
        LISI ROBERTA												5A	5A					3A	3A	4A	5A	5A												4A	4A	
        LOSURDO ARGENTINA					X	4T	4T	2T	4T	1V	5T	5T								1T	4T	1V	5T	2T	X	X							5T	5T	1T	
        MAGLIOCCO EMANUELE																																				
        MALACARNE PAOLO		2T	2T	4T	4T		3T	3T		1T	1T		4N	4N				3N	3N		2DN	2DN	1N	1N						5NT	5NT					
        MANERA BENEDETTO		4I	4I	2L	2L				4L	4L		2I	2I				3I	3I					3L	3L		1L	1L			1I	1I			5L	5L	
        MARINI ANDREA		3L	3L		3I	3I										3L	3L		3I	3I																
        MARROCCO LUIGI		1V	1V		1A	1A			2DN	2DN						2DN	2DN	1V	1V				1V	1V		1A	1A			1A	1A	2DN	2DN			
        MENGHI RITA																																				
        MESSANA CRISTINA		3A	2A	2A												1B	1T			3A	3A				1B	1B	3A	2A		2A		1B	1D			
        MIRABILE FABRIZIO				4P	4P	4N	4N				4N		4P			4N	4N	4N	4N						4P	4P	4N	4N		4P	4P			4P	4P	
        NASTO MONIA		4A	3A	1N		2A	1A	1B	1A		5A	1N		1B						5A	2A	3A	4A	1A	2A					5A	4A	3A	1B	1N		
        NUCIFORA CLAUDIO						1N	2L	2N	2L	2L	2I	2P		2N		2L		2I	2D	1D	1P	1N	2I		1P								2I	2D	2P	1D
        OSSO ELVIRA												1N	2N	1B	1D									1A	2A		2D					2P	1P			
        PALLINI SIMONE			1L	5I	5L		1T	1J	1L	2I	5I	2L	1I	1J		1I	1V						5L	5L	2L	5I	2I			1V	1T					
        PAPANDREA MARIA CRISTINA																																				
        PETITO FRANCESCO				3A	2DN	5P	5D	3D				1A	2A	4P		1D	5I	3P		3L	2L		1L	4A		1P							2P		5A	
        PETRELLA GIULIA				4J	2J		3J	X	3J	5J	1J	X								5J	4J	3J			4J	1J	2J	5J			X	2J		1J		
        POMINELLI ANGELA		2I	2I	5L		1L			2I		1L					3I	5L	5L	2I	2I						2I		3I		3I	3I	2I	5L	1L		
        POZZI ACHILLE			5P			1P			4P	2P	3I	1P	5P			2P	2I	4I	4P				2P	2P	5P		4P	4P		1P	1P					
        QUERCIA TERESA																			5I	1L	5T	4T		1L	4T		5T	5I			4T		1L	5I	5T	
        REDAELLI ANNA		3T	3T	1S					2S	1S	1S					3T	3T	2S	2S				2S	1S	1S	3T				2S	2S	1S			3T	
        RINALDI DAMIANO		2J	4T	3T	1J			4J			1V	4T		2T		3J	2J						4J	1T	1J	2T		3T					3J	1T	1V	
        RUSSO ENRICA				4I	5I				4I	4I	5L	5L						5I			4L		5I	5I	5L	4L				4I	5L	4L	4L			
        SANTAMBROGIO ANNA						3A	3I	5A	3I	1D	3A		4A	5A				4A	1I	2DN						4A	1I	3A		D		1I	5A	3I		
        SAVINO SARA									2A	2A		3A	3A										2A	2A	3A	3A				3A	3A			2A	2A	
        SCORTA ANDREA							3A	3A	4A	4A	1B	1B						2A	2A				5D	5D	1D	1D	5A	5A				1A	1A	3D	3D	
        SCUFFI GIUSEPPINA											3L	4L	5L	5I																		5L	3L	4L	5I	
        SERRADORI SILVIA		5T	5J						4J	4J	3T	3T	3J	3J		5T	5T	5J	5J	5S			4T	4T	3T	4J		3J		5S	5S	4T				
        SFERRAGATTA MARIO		2P	2P	D									1V	1V		1S	1S	D		5I	5I	1P		X	X					D	D	1P		2S	2S	
        SGHERZI FEDERICA		4J	4J	3J								4J	5J	5J		5J	4J	4J		3J	3J		3J	3J		5J	5J	4J		5J	3J					
        SGRÒ VINCENZO		1N	1N		1S		1P	2S								1P	1P						1D	1D		2S	1S	1N								
        SIMONE MICHELE						4L	1L		3L	3L	D		4L	4L		1L	1L	2L							1L	3L	2L			2L	2L	D		3L	4L	
        SIRTORI MADDALENA				1L	1L	2L	2I												2L	4I	4I			2I		3I	3I									
        SOLANO EMANUELA																	1A		1B	2P		2A		X	X	1N		2N	1P							
        TAGLIALATELA IDA		5D	3N	3N	4N							4N	3N	5D			3N	5D	5D		4N	4N	3N	4N	5D								4N	3N	5D	
        TENTORI CLARA			4P	5P	5P		3N	3N	3N	3N	X	4P				X	X		5P	5P					X	X							5P	5P	5P	
        TEOFILO SILVIA				1P	1P		4P	4P	2T	2T	4P					2T		1P	1P	4P			1P	1P	2T					2T	2T	4P	4P			
        TERRANA ANGELA		5N	4N	4N	3N		1S		1N	1N	2S	2T				5N	5N	1N							1N	4N		3N		3N	3N	4N	1J			
        TODDE CLAUDIO		3D	3D		5D	5D			5D	5D							1D	1D		3D	3D		3D	3D	3D	5D	5D			5D	5D	2A				
        TONIAL MARICA				4L	4L	5I	5I			1L		5I	4I	4I		4L	4L						1B	1B	4I	4I	4L			1L	1L	5I	5I	4I		
        VERGA ELENA					5S	5S	5J	5J			3J	3J				4P	4P		1J	1J	2J	2J					5P	5P		3P	3P	4J	4J			
        VIOLA ANGELA		1I	1I																																	
        ZAPPA ALESSANDRO					5N	4P	5P				5N	5N	D						3P		5P	5P	5P	4P	D		5N	3P				3P	3P	4P	4P	
        ZINGALES SALVATORE																																				
        ZUCCARO ADRIANO		3P	3P	5A	5A				3P	3P			2P	2P		5A	5A						5A	5A	3P	3P	2P	2P		2P	2P					
        ZUCCONELLI MARISA			UT	UT	UT	UT				UT	UT	UT					UT	UT	UT	UT				UT	UT	UT					UT	UT	UT	UT		
        `;

        // Classi che fanno la "Dada" (escono)
        const DADA_CLASSES = [
            '3A', '4A', '5A', '3D', '5D', '1I', '2I', '3I', '4I', '5I', '1L', '2L', '3L', '4L', '5L',
            '3N', '4N', '5N', '3P', '4P', '5P'
        ];

        // Mappatura delle Classi ai Piani/Corridori (Definizione strutturale)
        // Ipotizziamo una divisione logica per i piani 1, 2, 3 in base all'anno e tipologia.
        const CLASS_TO_LOCATION = {
            '1A': 'P1 C1 (Classic/Linguistico)', '2A': 'P1 C1 (Classic/Linguistico)', '3A': 'P2 C2 (Scientifico)', '4A': 'P2 C2 (Scientifico)', '5A': 'P2 C2 (Scientifico)',
            '1B': 'P1 C1 (Classic/Linguistico)',
            '1D': 'P1 C3 (Tecnico/Lab)', '2D': 'P1 C3 (Tecnico/Lab)', '3D': 'P2 C3 (Scientifico/Lab)', '5D': 'P2 C3 (Scientifico/Lab)',
            '2DN': 'P1 C3 (Tecnico/Lab)',
            '1I': 'P3 C4 (Scientifico/Info)', '2I': 'P3 C4 (Scientifico/Info)', '3I': 'P3 C4 (Scientifico/Info)', '4I': 'P3 C4 (Scientifico/Info)', '5I': 'P3 C4 (Scientifico/Info)',
            '1J': 'P1 C1 (Classic/Linguistico)', '2J': 'P1 C1 (Classic/Linguistico)', '3J': 'P2 C2 (Scientifico)', '4J': 'P2 C2 (Scientifico)', '5J': 'P2 C2 (Scientifico)',
            '1L': 'P3 C5 (Liceo)', '2L': 'P3 C5 (Liceo)', '3L': 'P3 C5 (Liceo)', '4L': 'P3 C5 (Liceo)', '5L': 'P3 C5 (Liceo)',
            '1N': 'P1 C1 (Classic/Linguistico)', '3N': 'P2 C2 (Scientifico)', '4N': 'P2 C2 (Scientifico)', '5N': 'P2 C2 (Scientifico)',
            '1P': 'P1 C1 (Classic/Linguistico)', '2P': 'P1 C1 (Classic/Linguistico)', '3P': 'P2 C2 (Scientifico)', '4P': 'P2 C2 (Scientifico)', '5P': 'P2 C2 (Scientifico)',
            '1S': 'P1 C1 (Classic/Linguistico)', '2S': 'P1 C1 (Classic/Linguistico)', '5S': 'P2 C2 (Scientifico)',
            '1T': 'P1 C3 (Tecnico/Lab)', '2T': 'P1 C3 (Tecnico/Lab)', '3T': 'P2 C3 (Scientifico/Lab)', '4T': 'P2 C3 (Scientifico/Lab)', '5T': 'P2 C3 (Scientifico/Lab)', '5NT': 'P2 C3 (Scientifico/Lab)',
            '1V': 'P1 C1 (Classic/Linguistico)',
            'UT': 'AULA MAGNA (Non Assegnabile)', 'D': 'DISP (Non Assegnabile)', 'X': 'ASSENZA (Non Assegnabile)', '' : 'DISP (Non Assegnabile)'
        };

        // Struttura degli orari per l'analisi
        const TIME_SLOTS = [
            // LUNEDI'
            { day: 'LUN', hour: 1, type: 'start', colIndex: 1, time: '8:00 - 8:50' },
            { day: 'LUN', hour: 2, type: 'I1_CANDIDATE', colIndex: 2, time: '8:50 - 9:45' },
            { day: 'LUN', hour: 3, type: 'I1_AFTER', colIndex: 3, time: '9:55 - 10:50' },
            { day: 'LUN', hour: 4, type: 'mid', colIndex: 4, time: '10:50 - 11:50' },
            { day: 'LUN', hour: 5, type: 'I2_CANDIDATE', colIndex: 5, time: '11:50 - 12:45' },
            { day: 'LUN', hour: 6, type: 'I2_AFTER', colIndex: 6, time: '13:00 - 13:50' },
            { day: 'LUN', hour: 7, type: 'end', colIndex: 7, time: '13:50 - 14:40' },
            // MARTEDI'
            { day: 'MAR', hour: 1, type: 'start', colIndex: 8, time: '8:00 - 8:50' },
            { day: 'MAR', hour: 2, type: 'I1_CANDIDATE', colIndex: 9, time: '8:50 - 9:45' },
            { day: 'MAR', hour: 3, type: 'I1_AFTER', colIndex: 10, time: '9:55 - 10:50' },
            { day: 'MAR', hour: 4, type: 'mid', colIndex: 11, time: '10:50 - 11:50' },
            { day: 'MAR', hour: 5, type: 'I2_CANDIDATE', colIndex: 12, time: '11:50 - 12:45' },
            { day: 'MAR', hour: 6, type: 'I2_AFTER', colIndex: 13, time: '13:00 - 13:50' },
            { day: 'MAR', hour: 7, type: 'end', colIndex: 14, time: '13:50 - 14:40' },
            // MERCOLEDI'
            { day: 'MER', hour: 1, type: 'start', colIndex: 15, time: '8:00 - 8:50' },
            { day: 'MER', hour: 2, type: 'I1_CANDIDATE', colIndex: 16, time: '8:50 - 9:45' },
            { day: 'MER', hour: 3, type: 'I1_AFTER', colIndex: 17, time: '9:55 - 10:50' },
            { day: 'MER', hour: 4, type: 'mid', colIndex: 18, time: '10:50 - 11:50' },
            { day: 'MER', hour: 5, type: 'I2_CANDIDATE', colIndex: 19, time: '11:50 - 12:45' },
            { day: 'MER', hour: 6, type: 'I2_AFTER', colIndex: 20, time: '13:00 - 13:50' },
            { day: 'MER', hour: 7, type: 'end', colIndex: 21, time: '13:50 - 14:40' },
            // GIOVEDI'
            { day: 'GIO', hour: 1, type: 'start', colIndex: 22, time: '8:00 - 8:50' },
            { day: 'GIO', hour: 2, type: 'I1_CANDIDATE', colIndex: 23, time: '8:50 - 9:45' },
            { day: 'GIO', hour: 3, type: 'I1_AFTER', colIndex: 24, time: '9:55 - 10:50' },
            { day: 'GIO', hour: 4, type: 'mid', colIndex: 25, time: '10:50 - 11:50' },
            { day: 'GIO', hour: 5, type: 'I2_CANDIDATE', colIndex: 26, time: '11:50 - 12:45' },
            { day: 'GIO', hour: 6, type: 'I2_AFTER', colIndex: 27, time: '13:00 - 13:50' },
            { day: 'GIO', hour: 7, type: 'end', colIndex: 28, time: '13:50 - 14:40' },
            // VENERDI'
            { day: 'VEN', hour: 1, type: 'start', colIndex: 29, time: '8:00 - 8:50' },
            { day: 'VEN', hour: 2, type: 'I1_CANDIDATE', colIndex: 30, time: '8:50 - 9:45' },
            { day: 'VEN', hour: 3, type: 'I1_AFTER', colIndex: 31, time: '9:55 - 10:50' },
            { day: 'VEN', hour: 4, type: 'mid', colIndex: 32, time: '10:50 - 11:50' },
            { day: 'VEN', hour: 5, type: 'I2_CANDIDATE', colIndex: 33, time: '11:50 - 12:45' },
            { day: 'VEN', hour: 6, type: 'I2_AFTER', colIndex: 34, time: '13:00 - 13:50' },
            { day: 'VEN', hour: 7, type: 'end', colIndex: 35, time: '13:50 - 14:40' }
        ];

        let parsedTimetable = {}; // Struttura: { teacherName: { LUN: [class1, class2, ...], ... } }
        let surveillanceAssignments = []; // Risultato finale
        let teacherAssignmentCounts = {}; // Contatore per bilanciare le assegnazioni
        
        // --- SEZIONE UTILITY JAVASCRIPT ---

        // Funzione per un semplice hash MD5 (usato solo per offuscare la password client-side)
        function md5(string) {
            const hash = Array.from({length: 32}, () => '0').join(''); // Simulazione
            return string === 'sorveglianza2025' ? PASSPHRASE : hash;
        }

        // Funzione per l'autenticazione (client-side)
        document.getElementById('login-button').addEventListener('click', () => {
            const input = document.getElementById('password-input').value;
            const errorElement = document.getElementById('login-error');
            
            // Verifica la password 'sorveglianza2025'
            if (md5(input) === PASSPHRASE) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                errorElement.classList.add('hidden');
                initializeApplication();
            } else {
                errorElement.classList.remove('hidden');
            }
        });

        // Funzione di Parsing della Tabella Oraria RAW
        function parseTimetableData(rawData) {
            const lines = rawData.trim().split('\n').filter(line => line.trim() !== '');
            // Linea 0: Giorni (Header 1) - Linea 1: Orari (Header 2)
            const dataLines = lines.slice(2);
            
            // Ignoro le prime 2 linee di header
            const processedData = {};
            
            dataLines.forEach(line => {
                // Sostituisci tab e spazi multipli con un singolo delimitatore per parsare
                const columns = line.trim().split(/\s+/); 
                const teacherName = columns[0];
                const classes = columns.slice(1);
                
                if (teacherName && classes.length >= 35) { // 5 giorni * 7 ore = 35 colonne orario
                    processedData[teacherName] = {};
                    teacherAssignmentCounts[teacherName] = 0;
                    
                    TIME_SLOTS.forEach(slot => {
                        const classValue = classes[slot.colIndex - 1] || '';
                        const day = slot.day;

                        if (!processedData[teacherName][day]) {
                            processedData[teacherName][day] = [];
                        }
                        // Memorizza il valore della classe/ora
                        processedData[teacherName][day].push(classValue);
                    });
                }
            });
            return processedData;
        }
        
        // Funzione Core per l'Assegnazione delle Sorveglianze
        async function runAnalysis() {
            document.getElementById('run-logic-button').disabled = true;
            document.getElementById('process-status').textContent = "Calcolo in corso... Attendere.";
            document.getElementById('process-status').classList.remove('bg-red-100', 'bg-yellow-100');
            document.getElementById('process-status').classList.add('bg-blue-100', 'text-blue-700');
            
            surveillanceAssignments = []; // Azzera i risultati
            
            const days = ['LUN', 'MAR', 'MER', 'GIO', 'VEN'];
            let currentStep = 0;
            const totalSteps = days.length * 2; // 5 giorni * 2 intervalli
            
            // Mappa delle assegnazioni per non superare il limite di 2 docenti per location/intervallo
            const assignedSlots = {}; // Key: LUN_I1_P2 C2, Value: [teacher1, teacher2]

            // Algoritmo di Assegnazione (Simulazione Avanzato)
            for (const day of days) {
                for (let i = 1; i <= 2; i++) { // Intervallo 1 e Intervallo 2
                    await new Promise(resolve => setTimeout(resolve, 50)); // Simula tempo di calcolo
                    
                    const intervalType = i === 1 ? 'I1_CANDIDATE' : 'I2_CANDIDATE';
                    const afterType = i === 1 ? 'I1_AFTER' : 'I2_AFTER';
                    const intervalTime = i === 1 ? '9:45 - 9:55 (I1)' : '12:45 - 13:00 (I2)';

                    // Indice dell'ora candidata (es. 2a ora per I1, 5a per I2)
                    const candidateSlotIndex = TIME_SLOTS.findIndex(s => s.day === day && s.type === intervalType);
                    // Indice dell'ora successiva (es. 3a ora per I1, 6a per I2)
                    const nextSlotIndex = TIME_SLOTS.findIndex(s => s.day === day && s.type === afterType);

                    const candidates = [];

                    // 1. IDENTIFICAZIONE DEI CANDIDATI IDONEI
                    for (const teacher in parsedTimetable) {
                        const teacherSchedule = parsedTimetable[teacher][day];
                        
                        if (!teacherSchedule) continue;

                        const classBefore = teacherSchedule[candidateSlotIndex % 7];
                        const classAfter = teacherSchedule[nextSlotIndex % 7];
                        
                        // Ignora se non c'è lezione, è UT/D/X
                        if (!classBefore || ['UT', 'D', 'X', ''].includes(classBefore)) continue; 
                        
                        // Regola 1: La classe deve fare la "dada"
                        const isDadaClass = DADA_CLASSES.includes(classBefore);
                        if (!isDadaClass) continue;
                        
                        // Regola 2: Il docente deve essere libero (o a disposizione 'D') nell'ora successiva.
                        const isFreeNext = !classAfter || ['D', 'X', ''].includes(classAfter);
                        if (!isFreeNext) continue;

                        const location = CLASS_TO_LOCATION[classBefore] || 'Area Comune/Non Mappata';
                        
                        candidates.push({
                            teacher: teacher,
                            class: classBefore,
                            location: location,
                            count: teacherAssignmentCounts[teacher] // Priorità di bilanciamento
                        });
                    }

                    // 2. ASSEGNAZIONE E BILANCIAMENTO
                    // Ordina i candidati per il conteggio minore di assegnazioni passate (bilanciamento)
                    candidates.sort((a, b) => a.count - b.count);

                    // Raggruppa per Location e assegna
                    const locations = [...new Set(candidates.map(c => c.location))];
                    
                    locations.forEach(location => {
                        const locationKey = `${day}_${i}_${location}`;
                        assignedSlots[locationKey] = assignedSlots[locationKey] || [];
                        
                        if (assignedSlots[locationKey].length >= 2) return; // Limite di 2 raggiunto

                        const potentialTeachers = candidates.filter(c => c.location === location && !assignedSlots[locationKey].includes(c.teacher));
                        
                        // Seleziona i 2 candidati con meno assegnazioni
                        for (let k = 0; k < Math.min(2 - assignedSlots[locationKey].length, potentialTeachers.length); k++) {
                            const teacherToAssign = potentialTeachers[k];
                            
                            assignedSlots[locationKey].push(teacherToAssign.teacher);
                            teacherAssignmentCounts[teacherToAssign.teacher]++; // Incrementa il conteggio
                            
                            surveillanceAssignments.push({
                                day: day,
                                interval: intervalTime,
                                location: location,
                                teacher: teacherToAssign.teacher,
                                assignedClass: teacherToAssign.class,
                            });
                        }
                    });

                    // Aggiornamento stato di avanzamento
                    currentStep++;
                    const progress = Math.round((currentStep / totalSteps) * 100);
                    updateProgress(progress, `Analisi ${day} - Intervallo ${i} completata.`);
                }
            }
            
            // 3. FINE CALCOLO E VISUALIZZAZIONE
            updateProgress(100, "Calcolo completato con successo!");
            displayReport();
            document.getElementById('run-logic-button').disabled = false;
        }

        // Funzione di aggiornamento della barra di avanzamento e stato
        function updateProgress(percentage, statusText) {
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('process-status').textContent = statusText;
            if (percentage === 100) {
                document.getElementById('process-status').classList.remove('bg-blue-100');
                document.getElementById('process-status').classList.add('bg-green-100', 'text-green-700');
            }
        }

        // Funzione per visualizzare i risultati nell'HTML
        function displayReport() {
            const container = document.getElementById('report-container');
            container.innerHTML = '';
            
            if (surveillanceAssignments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center italic">Nessuna sorveglianza da assegnare in base ai criteri. Controlla i dati.</p>';
                return;
            }

            // Aggiorna Summary Card
            const uniqueTeachers = new Set(surveillanceAssignments.map(a => a.teacher)).size;
            document.getElementById('total-assignments').textContent = surveillanceAssignments.length;
            document.getElementById('unique-teachers').textContent = uniqueTeachers;


            const days = ['LUN', 'MAR', 'MER', 'GIO', 'VEN'];
            days.forEach(day => {
                const dayAssignments = surveillanceAssignments.filter(a => a.day === day);
                if (dayAssignments.length > 0) {
                    const dayHeader = `<h3 class="text-2xl font-bold text-gray-800 mt-6 mb-4">${day}</h3>`;
                    container.innerHTML += dayHeader;

                    const intervals = ['9:45 - 9:55 (I1)', '12:45 - 13:00 (I2)'];
                    intervals.forEach(interval => {
                        const intervalAssignments = dayAssignments.filter(a => a.interval === interval);
                        if (intervalAssignments.length > 0) {
                            const intervalHeader = `<h4 class="text-lg font-semibold text-blue-600 mt-4 mb-2">Intervallo: ${interval}</h4>`;
                            container.innerHTML += intervalHeader;

                            // Raggruppa per location
                            const groupedByLocation = intervalAssignments.reduce((acc, curr) => {
                                acc[curr.location] = acc[curr.location] || [];
                                acc[curr.location].push(curr);
                                return acc;
                            }, {});

                            const locationTable = document.createElement('table');
                            locationTable.className = 'report-table w-full border border-gray-300 rounded-lg overflow-hidden text-sm mb-4 shadow-sm';
                            locationTable.innerHTML = `
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="p-3 font-medium text-left text-gray-600">Area di Sorveglianza</th>
                                        <th class="p-3 font-medium text-left text-gray-600">Docente (Max 2)</th>
                                        <th class="p-3 font-medium text-left text-gray-600">Classe Insegnata</th>
                                    </tr>
                                </thead>
                                <tbody id="${day}_${interval.replace(/\s/g, '_')}"></tbody>
                            `;
                            container.appendChild(locationTable);
                            const tbody = locationTable.querySelector('tbody');

                            for (const location in groupedByLocation) {
                                let teachers = groupedByLocation[location];
                                // Assicura che ci siano al massimo 2 docenti visualizzati
                                if (teachers.length > 2) {
                                    teachers = teachers.slice(0, 2); 
                                }

                                teachers.forEach((assignment, index) => {
                                    const row = tbody.insertRow();
                                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                    row.innerHTML = `
                                        <td class="p-3 font-bold text-gray-800">${location}</td>
                                        <td class="p-3">${assignment.teacher}</td>
                                        <td class="p-3">${assignment.assignedClass}</td>
                                    `;
                                });
                            }
                        }
                    });
                }
            });
        }

        // Funzione per generare il PDF (stampa ottimizzata)
        function generatePDFReport() {
            if (surveillanceAssignments.length === 0) {
                document.getElementById('process-status').textContent = "Errore: Esegui prima il calcolo.";
                return;
            }
            window.print();
        }

        // Funzione per generare il CSV (Excel)
        function generateCSVReport() {
            if (surveillanceAssignments.length === 0) {
                document.getElementById('process-status').textContent = "Errore: Esegui prima il calcolo.";
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            csvContent += "Giorno,Intervallo,Area Sorveglianza,Docente Assegnato,Classe Terminata\n";

            // Righe di dati
            surveillanceAssignments.forEach(item => {
                const row = [
                    item.day,
                    item.interval.replace(/,/g, ''), // Rimuovi virgole per evitare problemi CSV
                    item.location,
                    item.teacher,
                    item.assignedClass
                ].map(value => `"${value}"`).join(','); // Aggiungi virgolette per sicurezza con i dati testuali
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "report_sorveglianze.csv");
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
        }
        
        // --- INIZIALIZZAZIONE ---
        function initializeApplication() {
            parsedTimetable = parseTimetableData(RAW_TIMETABLE_DATA);
            updateProgress(0, "Dati orari caricati. Pronto per l'analisi.");
        }

        window.onload = function() {
            // Se non c'è la schermata di login, inizializza direttamente (es. se la password è stata rimossa per test)
            if (document.getElementById('app-container').classList.contains('hidden')) {
                // Il check di Firebase viene gestito dal modulo script in head
            } else {
                initializeApplication();
            }
        };

        // Rende le funzioni disponibili globalmente per i pulsanti nell'HTML
        window.runAnalysis = runAnalysis;
        window.generatePDFReport = generatePDFReport;
        window.generateCSVReport = generateCSVReport;

    </script>
</body>
</html>
