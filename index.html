<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Sorveglianze Scolastiche</title>
    <!-- Caricamento di Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Caricamento della libreria jsPDF per la generazione di PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Inter per estetica -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <!-- Header e Status -->
    <header class="bg-white shadow-lg rounded-xl p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <h1 class="text-3xl font-extrabold text-blue-800">Sistema di Sorveglianza Intervalli</h1>
            <div class="mt-4 md:mt-0 flex items-center space-x-4">
                <span id="firebase-status" class="px-3 py-1 text-sm font-medium rounded-full transition duration-300">
                    Connessione DB: <span id="status-text">In attesa...</span>
                </span>
                <div class="text-gray-600 text-sm">Referente: Marisa Zucconelli</div>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-blue-50 p-3 rounded-lg text-center shadow-inner">
                <div class="text-3xl font-bold text-blue-700" id="total-sorveglianze">0</div>
                <div class="text-sm text-blue-600">Sorveglianze Totali Assegnate</div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg text-center shadow-inner">
                <div class="text-3xl font-bold text-blue-700" id="involved-teachers">0</div>
                <div class="text-sm text-blue-600">Docenti Coinvolti</div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg text-center shadow-inner">
                <div class="text-3xl font-bold text-blue-700" id="progress-indicator">0%</div>
                <div class="text-sm text-blue-600">Avanzamento Calcolo</div>
            </div>
            <button onclick="startCalculation()" id="start-calc-btn" class="col-span-2 md:col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition duration-150 transform hover:scale-105">
                Avvia Calcolo Sorveglianze
            </button>
        </div>
    </header>

    <!-- Sezione Dati Utente (Input Classi/Piani) -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Configurazione Aule/DADA
            </h2>
            <p class="text-sm text-gray-500 mb-4">Definisci la posizione (Piano, Corridoio, Aula) per ogni classe DADA. **Per le classi NON-DADA, solo l'Aula è richiesta.**</p>
            
            <div id="class-location-input" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <!-- Verranno popolati qui gli input dinamici -->
            </div>
        </div>

        <!-- Sezione Risultati e Scarica PDF -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Rapporto Sorveglianze Finale
                </h2>
                <button onclick="downloadPDF()" id="download-pdf-btn" disabled class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v7a1 1 0 11-2 0V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Scarica PDF
                </button>
            </div>

            <!-- Filtro Intelligente -->
            <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                <label for="smart-filter" class="block text-sm font-medium text-yellow-800 mb-2">Filtro di Verifica Intelligente:</label>
                <select id="smart-filter" onchange="filterResults()" class="w-full p-2 border border-yellow-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500">
                    <option value="all">Tutti i Risultati</option>
                    <option value="needs-two">Mostra solo Sorveglianze con 1 solo Docente</option>
                    <option value="unassigned">Mostra solo Sorveglianze Non Assegnate</option>
                    <option value="high-load">Mostra Docenti con più di 4 Sorveglianze</option>
                </select>
            </div>

            <div id="surveillance-results" class="space-y-6 max-h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500 mt-10">Inserisci la configurazione delle aule e clicca su "Avvia Calcolo" per generare il piano di sorveglianza.</p>
                <!-- I risultati delle sorveglianze verranno iniettati qui -->
            </div>
        </div>

        <!-- Sezione Orario Docenti (Modificabile) -->
        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg mt-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M12 11h.01M15 11h.01M7 15h.01M11 15h.01M15 15h.01M17 3H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2z" />
                </svg>
                Orario Docenti (Clicca su una cella per modificare)
            </h2>
            <div class="overflow-x-auto">
                <table id="teacher-schedule-table" class="data-table w-full text-sm">
                    <!-- Tabella orario docenti generata da JS -->
                </table>
            </div>
        </div>
    </main>

    <!-- Script Logica Firebase, Dati, e Calcolo -->
    <script type="module">
        // ====================================================================
        // CONFIGURAZIONE FIREBASE E AUTENTICAZIONE
        // Nota: La password criptata lato client non è una misura di sicurezza
        // reale in un file HTML. Per autenticazione robusta è necessario un
        // backend. Per questo esercizio, l'accesso è diretto come richiesto.
        // ====================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Variabili Globali del Canvas (MANDATORIE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyCgVfSzyZi1jIOXvGqe17bsuaVbBr9bW8A",
            authDomain: "oresorveglianza.firebaseapp.com",
            projectId: "oresorveglianza",
            storageBucket: "oresorveglianza.firebasestorage.app",
            messagingSenderId: "55401666581",
            appId: "1:55401666581:web:c1f303fc1607241df4561c",
            measurementId: "G-GV2ERZ13NG"
        }));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anon_user';

        async function initFirebase() {
            try {
                const statusElement = document.getElementById('firebase-status');
                const statusText = document.getElementById('status-text');

                statusText.textContent = 'Connessione in corso...';
                statusElement.classList.remove('bg-gray-200');
                statusElement.classList.add('bg-yellow-200', 'text-yellow-800');

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                getAnalytics(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();

                statusText.textContent = 'Connesso';
                statusElement.classList.remove('bg-yellow-200', 'text-yellow-800');
                statusElement.classList.add('bg-green-200', 'text-green-800');

            } catch (error) {
                console.error("Errore di inizializzazione Firebase o autenticazione:", error);
                const statusElement = document.getElementById('firebase-status');
                const statusText = document.getElementById('status-text');
                statusText.textContent = 'Errore';
                statusElement.classList.remove('bg-yellow-200', 'text-yellow-800');
                statusElement.classList.add('bg-red-200', 'text-red-800');
            }
        }

        // ====================================================================
        // DATI STATICI E MODELLI
        // ====================================================================

        const TEACHER_SCHEDULE_DATA = {
            // Struttura: [Docente, Lun1, Lun2, Lun3, Lun4, Lun5, Lun6, Lun7, Mar1, ..., Ven7]
            ABBIATI_CHIARA: ["ABBIATI CHIARA", "", "", "5J", "3T", "2J", "4J", "", "5J", "3J", "", "1J", "2J", "3T", "", "4J", "3J", "", "", "", "", "", "", "4J", "5J", "2J", "3T", "1J", "", "", "", "", "", "3J", "1J", ""],
            ARCARA_MATTEO: ["ARCARA MATTEO", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "1S", "3I", "5S", "", "4I", "2S", "1B", "", "", "", "", "", "", "", ""],
            ARGENTINA_COSIMO: ["ARGENTINA COSIMO", "5J", "5D", "D", "3J", "3J", "", "", "", "", "", "", "4J", "2J", "", "5D", "5J", "", "4J", "", "", "", "5J", "5J", "3J", "", "", "", "", "4J", "4J", "3J", "5J", "", "2J", ""],
            BACCO_ALESSANDRA: ["BACCO ALESSANDRA", "", "", "", "1D", "1D", "", "", "", "", "2DN", "2DN", "1D", "1D", "", "3D", "3D", "", "", "3P", "3P", "", "2DN", "2DN", "", "", "", "", "", "3D", "3D", "", "1D", "3P", "3P", ""],
            BAJ_SARAH: ["BAJ SARAH", "2A", "", "1A", "", "2P", "2N", "1P", "", "", "", "", "", "", "", "", "", "", "", "1A", "1J", "", "", "", "", "", "", "", "", "2N", "2A", "1J", "", "2P", "1P", ""],
            BAÙ_GIORGIA: ["BAÙ GIORGIA", "2DN", "2S", "", "1N", "", "1D", "1V", "1V", "1D", "1N", "", "", "", "", "", "", "", "1T", "2DN", "1N", "1D", "", "", "2DN", "D", "1D", "1V", "", "", "", "", "", "1P", "1S", ""],
            BELLOTTI_GABRIELE: ["BELLOTTI GABRIELE", "4N", "D", "3P", "", "", "", "", "D", "D", "D", "", "4P", "5P", "", "", "", "", "", "", "4P", "3P", "4N", "", "4P", "4P", "4N", "4N", "", "4P", "4P", "5P", "", "", "", ""],
            BENFENATI_ANDREA: ["BENFENATI ANDREA", "", "", "", "2T", "3D", "4L", "5D", "", "", "", "3N", "", "5L", "", "", "5D", "3D", "2T", "", "5L", "3N", "2T", "5P", "4L", "3D", "3N", "1J", "", "5L", "4L", "5D", "", "", "", ""],
            BIFFI_ELENA: ["BIFFI ELENA", "", "", "", "1V", "1V", "1B", "1N", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "1V", "", "1P", "1A", "1D", "", "", "", "", "", "", ""],
            BORZUMATI_GIUSEPPE: ["BORZUMATI GIUSEPPE", "2L", "3I", "1B", "1B", "5L", "3L", "", "5I", "3I", "", "", "", "", "", "2I", "", "1A", "1A", "1B", "", "", "", "", "2I", "2L", "5I", "5L", "", "", "", "", "", "1A", "3L", ""],
            BOTTA_RAFFAELLA: ["BOTTA RAFFAELLA", "5A", "5A", "", "3A", "4A", "5S", "1S", "", "", "", "5S", "1S", "2S", "", "", "", "5S", "5S", "", "4A", "4A", "5S", "5S", "2S", "", "", "", "", "", "", "", "", "5A", "3A", ""],
            BOTTON_CRISTINA: ["BOTTON CRISTINA", "", "", "2T", "2A", "1J", "2S", "", "", "", "", "1S", "2S", "1T", "", "1J", "2T", "", "", "2J", "1V", "", "", "", "1A", "2A", "1T", "1S", "", "", "", "", "2J", "1V", "1A", ""],
            BRUNETTA_VIVIANA: ["BRUNETTA VIVIANA", "", "", "", "", "", "", "", "D", "D", "D", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "D", "D", "", ""],
            BUCOLO_ROSARIO: ["BUCOLO ROSARIO", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            CALABRESE_M: ["CALABRESE M", "", "2N", "2P", "2P", "", "", "", "", "", "", "3L", "3L", "", "1A", "1A", "", "1B", "2P", "3I", "", "", "", "", "", "2N", "2N", "1A", "", "3L", "3I", "3I", "1B", "1B", ""],
            CALIFANO_CARMELA: ["CALIFANO CARMELA", "3J", "3J", "", "", "", "", "", "1T", "", "4J", "", "", "", "", "1V", "D", "3J", "3J", "", "", "4J", "", "", "D", "", "4J", "1T", "", "3J", "D", "D", "1V", "4J", "4J", ""],
            CANNELLA_CHIARA: ["CANNELLA CHIARA", "", "2D", "2N", "", "", "", "", "1D", "1B", "", "", "", "", "", "", "", "2D", "1N", "1P", "1A", "2P", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            CAPODICI_FRANCESCO: ["CAPODICI FRANCESCO", "1P", "", "2D", "2S", "", "2J", "2P", "", "", "", "", "2N", "1P", "1D", "", "", "", "1D", "1D", "2P", "2S", "", "", "2J", "2N", "2D", "2T", "", "", "2N", "2P", "1P", "2T", "2D", ""],
            CAPUTO_SERENA: ["CAPUTO SERENA", "", "4L", "5D", "3L", "1I", "1I", "", "1I", "", "4L", "", "", "", "", "", "", "3L", "3L", "", "", "", "4L", "4L", "1I", "1I", "", "5D", "", "", "", "3L", "5D", "", "", ""],
            CARPINO_GIACOMO: ["CARPINO GIACOMO", "", "", "", "D", "3N", "5N", "5N", "", "", "", "D", "D", "3N", "", "", "", "5N", "5N", "3N", "3N", "", "", "", "", "3N", "D", "5N", "", "", "", "3N", "3N", "5N", "5N", ""],
            CASALINO_ANGELO: ["CASALINO ANGELO", "1J", "2J", "D", "", "", "", "", "", "", "", "", "", "", "", "2J", "1J", "D", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            CASIRAGHI_ANDREA: ["CASIRAGHI ANDREA", "3D", "3D", "", "5D", "5D", "", "", "", "", "3D", "3D", "5D", "", "", "", "", "1D", "", "3D", "3D", "5D", "3D", "3D", "3D", "5D", "5D", "1D", "", "5D", "5D", "3D", "3D", "5D", "1D", ""],
            CASTOLDI_VALERIA: ["CASTOLDI VALERIA", "", "", "", "", "", "", "", "5P", "5P", "", "1T", "", "", "", "5P", "5P", "1T", "", "", "", "", "", "", "", "", "", "", "", "5P", "5P", "1T", "1T", "", "", ""],
            CATALDO_FEDERICA: ["CATALDO FEDERICA", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "2A", "2A", "", "4A", "4A", "", "", "", "", "", "", "", "", "", "", "", "", "2A", "4A", "4A", ""],
            CAVALIERATOS_ANGELA: ["CAVALIERATOS ANGELA", "", "", "", "D", "1B", "2A", "1A", "", "1A", "", "D", "1B", "2A", "", "", "", "", "D", "2A", "1B", "1A", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            CAVICCHIONI_CRISTINA: ["CAVICCHIONI CRISTINA", "1S", "2L", "2I", "1T", "", "", "", "", "", "", "", "", "", "", "", "", "", "1T", "2L", "2I", "1S", "", "", "", "", "", "", "", "1T", "2I", "", "", "2L", "1S", ""],
            CIMINO_SALVATORE: ["CIMINO SALVATORE", "3N", "2D", "2N", "", "", "", "", "1P", "1P", "2P", "", "2D", "2D", "", "3N", "1D", "2N", "2N", "1P", "", "", "D", "D", "2P", "2P", "", "", "", "", "", "", "", "1D", "1D", ""],
            CIMMINO_MARIO: ["CIMMINO MARIO", "", "", "", "", "2S", "1J", "2J", "2J", "2S", "2T", "", "1T", "1S", "", "", "", "", "", "2T", "1T", "1J", "1T", "2S", "", "1S", "1J", "2J", "", "", "", "", "", "1S", "2T", ""],
            CIONCI_SIMONA: ["CIONCI SIMONA", "1B", "1B", "D", "D", "D", "", "1T", "", "", "", "", "", "", "", "1T", "1B", "1B", "", "", "", "", "", "", "", "", "", "", "", "1B", "1B", "", "", "", "", ""],
            CITTERIO_MAURIZIO: ["CITTERIO MAURIZIO", "1L", "", "", "", "", "", "", "5L", "5L", "2L", "1L", "1L", "", "", "5L", "2L", "1L", "1L", "", "", "", "2L", "2L", "", "", "5L", "", "5L", "", "", "", "", "", "", ""],
            COGLIATI_LUIGI: ["COGLIATI LUIGI", "", "", "", "3P", "4N", "4N", "", "5N", "4N", "4N", "", "3P", "3P", "", "3P", "3P", "4N", "4N", "D", "", "", "3P", "3P", "", "", "", "", "", "4N", "4N", "", "5N", "", "", ""],
            COLOMBO_GIULIANA: ["COLOMBO GIULIANA", "2S", "4N", "2J", "3N", "", "1S", "", "1S", "2J", "2S", "2T", "", "", "", "2S", "2S", "2T", "", "1S", "1S", "", "2J", "2J", "1N", "", "", "", "", "", "", "2T", "2T", "", "", ""],
            COLOMBO_RUGGERO: ["COLOMBO RUGGERO", "5I", "5I", "1I", "1I", "", "", "", "", "1I", "1I", "1I", "5I", "", "", "", "", "", "", "", "", "", "", "1I", "1I", "5I", "", "", "", "", "", "", "", "", "", "", ""],
            COLZANI_BARBARA: ["COLZANI BARBARA", "5P", "2S", "3L", "4I", "2J", "", "", "1V", "", "5S", "2S", "", "", "", "4I", "5S", "5P", "", "", "", "", "4I", "5P", "3L", "", "", "", "", "3L", "D", "", "2S", "5S", "", ""],
            COMI_LUCA: ["COMI LUCA", "", "", "", "", "", "", "", "5D", "5D", "5D", "5D", "3D", "3D", "", "", "", "", "", "5D", "5D", "3D", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            CONTI_DAMIANA: ["CONTI DAMIANA", "", "", "", "", "", "", "", "", "", "5A", "5A", "3A", "", "", "", "", "3A", "3A", "", "5A", "5A", "3A", "3A", "5A", "", "", "", "", "", "", "", "", "", "", ""],
            CORTI_CHIARA: ["CORTI CHIARA", "", "", "4P", "4P", "3P", "3P", "5P", "4N", "4P", "5P", "5P", "5N", "5N", "", "4N", "4N", "4P", "", "5N", "", "", "5N", "3N", "3N", "5P", "3P", "", "", "", "", "", "", "4N", "3N", ""],
            CORVI_LAURA: ["CORVI LAURA", "4L", "", "1D", "1D", "4I", "4I", "2A", "1D", "", "1P", "", "", "", "", "", "4I", "2D", "4L", "4L", "", "2A", "", "", "", "1N", "2A", "1P", "1P", "2D", "2D", "1N", "1N", "", "", ""],
            COTRONEO_SIMONA: ["COTRONEO SIMONA", "5S", "5S", "2S", "", "", "", "", "3T", "3T", "", "", "", "", "", "5S", "", "3T", "1S", "2S", "", "", "", "3T", "", "5S", "5S", "", "", "1S", "", "", "", "", "", ""],
            CRESCENTI_SALVATORE: ["CRESCENTI SALVATORE", "", "", "", "", "1T", "5L", "4N", "", "", "3N", "", "1J", "4J", "", "", "", "", "", "3T", "1I", "5NT", "", "", "", "1V", "2T", "4L", "1N", "2I", "5J", "", "4T", "2J", "3J", ""],
            CRIPPA_ELENA: ["CRIPPA ELENA", "", "", "", "5J", "5J", "", "", "", "", "5J", "5J", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "5J", "5J", ""],
            CUCCHIARA_ROSALINDA: ["CUCCHIARA ROSALINDA", "3I", "4L", "", "2I", "2I", "", "", "", "5I", "3I", "3I", "", "", "", "5I", "2I", "4I", "", "", "", "", "3I", "4I", "1I", "1I", "", "", "", "5I", "5I", "4I", "4I", "2I", "", ""],
            CURIA_CLELIA: ["CURIA CLELIA", "", "", "1T", "", "2T", "1V", "5S", "", "", "", "", "2T", "5S", "", "", "", "", "", "1V", "2T", "1T", "", "", "", "1T", "1V", "5S", "", "", "", "", "", "", "", ""],
            D_AMICO_ROMINA: ["D'AMICO ROMINA", "", "", "", "", "", "", "", "5S", "5S", "2J", "2J", "", "", "", "", "", "2J", "2J", "", "5S", "5S", "", "", "", "", "", "", "", "2J", "2J", "5S", "5S", "", "", ""],
            DE_BENEDETTI_SERGIO: ["DE BENEDETTI SERGIO", "1A", "1A", "1V", "4A", "", "", "", "5A", "5A", "1A", "1V", "", "", "", "4A", "4A", "1L", "1L", "", "", "", "1A", "2L", "", "5A", "", "", "", "4A", "1V", "1V", "", "", "", ""],
            DE_FABRIS_ANNALISA: ["DE FABRIS ANNALISA", "", "1S", "5S", "", "3T", "", "5T", "", "", "", "", "5S", "4T", "", "", "", "1S", "4T", "5T", "2S", "3T", "", "", "", "4T", "2S", "5T", "", "", "", "2S", "1S", "3T", "5S", ""],
            DELLA_TORRE_ANNA: ["DELLA TORRE ANNA", "", "4A", "4A", "", "5A", "5A", "", "3A", "3A", "4A", "4A", "", "", "", "3A", "3A", "5A", "5A", "", "", "", "", "", "", "", "4A", "4A", "", "", "5A", "5A", "3A", "3A", "", ""],
            DI_DIA_VITO: ["DI DIA VITO", "", "", "", "", "2N", "2D", "2D", "", "1B", "2A", "2A", "1A", "1A", "", "", "2P", "2P", "1N", "", "1A", "2P", "", "", "", "2D", "1B", "1B", "", "1N", "1N", "2A", "", "2N", "2N", ""],
            DI_STASIO_MARIA_GRAZIA: ["DI STASIO MARIA GRAZIA", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            ESPOSITO_ERIKA: ["ESPOSITO ERIKA", "", "", "5P", "5P", "3P", "3P", "", "", "", "5P", "5P", "3P", "3P", "", "", "", "", "5P", "5P", "5P", "5P", "3P", "3P", "", "", "", "", "", "", "", "3P", "3P", "5P", "5P", ""],
            FILIPPA_FRANCESCA: ["FILIPPA FRANCESCA", "", "4A", "4A", "", "5A", "5A", "", "3A", "3A", "4A", "4A", "", "", "", "3A", "3A", "5A", "5A", "", "", "", "", "", "", "", "4A", "4A", "", "", "5A", "5A", "3A", "3A", "", ""],
            FIRRINCIELI_GIOVANNI: ["FIRRINCIELI GIOVANNI", "1D", "1D", "3D", "3D", "", "1N", "", "3D", "3D", "1D", "1D", "1N", "", "", "1N", "1N", "", "3D", "D", "", "", "", "", "", "", "", "3D", "1D", "1D", "1D", "", "", "", "", ""],
            FRAIESE_ALESSIA: ["FRAIESE ALESSIA", "4T", "1J", "1J", "", "", "4A", "4A", "", "", "", "", "4T", "4A", "", "4T", "4T", "", "", "", "", "", "1J", "1J", "4A", "", "4T", "4T", "", "1J", "1J", "4A", "4A", "", "", ""],
            FRATTA_DONATO: ["FRATTA DONATO", "", "", "", "", "1S", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "1S", "", "", "", "", ""],
            GALBIATI_ALESSANDRA: ["GALBIATI ALESSANDRA", "", "", "", "4J", "4J", "5T", "3J", "", "", "", "", "5T", "5T", "", "", "", "4T", "3T", "4J", "5J", "5J", "", "", "", "3J", "3J", "", "", "3T", "3T", "5J", "", "4T", "4T", ""],
            GAVAZZI_IRIS: ["GAVAZZI IRIS", "", "", "", "", "", "", "", "", "", "4I", "4I", "2L", "1N", "", "", "", "", "", "", "", "", "", "", "", "1N", "4I", "", "", "", "2L", "2L", "", "4I", ""],
            GHALI_SAMIRA: ["GHALI SAMIRA", "1N", "1N", "1B", "1B", "", "", "", "", "", "", "", "", "", "", "1P", "1P", "1A", "1A", "", "", "", "1D", "1D", "", "", "", "", "", "", "", "", "", "", "", ""],
            GIARDINA_GIUSI: ["GIARDINA GIUSI", "5L", "5L", "3I", "", "3L", "", "", "", "", "", "3L", "3I", "3I", "", "", "1I", "1I", "5L", "5L", "3L", "", "", "", "3I", "5L", "3L", "3L", "", "", "", "", "", "1I", "3I", ""],
            GIUNTA_CALOGERO: ["GIUNTA CALOGERO", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "4L", "4I", "1I", "1L", "", "", "", "", "", "", "", "", "4L", "4I", "1L", "1I", "", "", ""],
            GRIFÒ_VALENTINA: ["GRIFÒ VALENTINA", "", "", "", "5T", "5T", "2T", "4T", "5T", "4T", "4T", "", "3T", "", "", "", "", "5T", "5T", "4T", "3T", "2T", "3T", "5T", "", "", "", "", "", "4T", "", "3T", "3T", "", "", ""],
            IAVARONE_LAURA: ["IAVARONE LAURA", "", "", "", "", "2D", "3D", "1D", "1B", "D", "", "", "", "", "", "D", "D", "", "", "1N", "1D", "1B", "", "", "", "", "3D", "2D", "", "", "", "1D", "D", "D", "1N", ""],
            IOP_ELENA: ["IOP ELENA", "1T", "1T", "2J", "", "", "", "", "1J", "1J", "1A", "1V", "", "", "", "2P", "1T", "1J", "", "3P", "", "", "2DN", "", "1T", "1B", "", "2A", "", "4A", "1P", "3L", "1J", "", ""],
            LA_MATTINA_ELENA: ["LA MATTINA ELENA", "", "5NT", "5NT", "", "", "", "", "", "5NT", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "5NT", "5NT", "", "", "", "", "", "5NT", "", "", "", ""],
            LA_PAGLIA_DOMINGO: ["LA PAGLIA DOMINGO", "", "", "", "", "", "5N", "5N", "3N", "3N", "5N", "5N", "5N", "5N", "", "", "", "5N", "5N", "3N", "3N", "", "", "3N", "3N", "", "", "", "", "", "", "3N", "3N", "5N", "5N", ""],
            LILLIU_DANIELA: ["LILLIU DANIELA", "4P", "1P", "", "1N", "5N", "2P", "3P", "2P", "", "3P", "3P", "1P", "", "", "", "", "", "2P", "4N", "5N", "4P", "4P", "5N", "4N", "", "", "", "", "", "", "", "", "1P", "4N", ""],
            LISI_ROBERTA: ["LISI ROBERTA", "", "", "", "", "", "", "", "", "", "5A", "5A", "", "", "", "", "", "3A", "3A", "4A", "5A", "5A", "", "", "", "", "", "", "", "", "", "", "", "4A", "4A", ""],
            LOSURDO_ARGENTINA: ["LOSURDO ARGENTINA", "", "", "", "", "4T", "4T", "2T", "4T", "1V", "5T", "5T", "", "", "", "", "", "", "", "1T", "4T", "1V", "5T", "2T", "", "", "", "", "", "", "", "", "5T", "5T", "1T", ""],
            MAGLIOCCO_EMANUELE: ["MAGLIOCCO EMANUELE", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            MALACARNE_PAOLO: ["MALACARNE PAOLO", "2T", "2T", "4T", "4T", "", "3T", "3T", "", "1T", "1T", "", "4N", "4N", "", "", "", "3N", "3N", "", "2DN", "2DN", "1N", "1N", "", "", "", "", "", "5NT", "5NT", "", "", "", "", ""],
            MANERA_BENEDETTO: ["MANERA BENEDETTO", "4I", "4I", "2L", "2L", "", "", "", "4L", "4L", "", "2I", "2I", "", "", "", "3I", "3I", "", "", "", "", "3L", "3L", "", "1L", "1L", "", "", "1I", "1I", "", "", "5L", "5L", ""],
            MARINI_ANDREA: ["MARINI ANDREA", "3L", "3L", "", "3I", "3I", "", "", "", "", "", "", "", "", "", "3L", "3L", "", "3I", "3I", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            MARROCCO_LUIGI: ["MARROCCO LUIGI", "1V", "1V", "", "1A", "1A", "", "", "2DN", "2DN", "", "", "", "", "", "2DN", "2DN", "1V", "1V", "", "", "", "1V", "1V", "", "1A", "1A", "", "", "1A", "1A", "2DN", "2DN", "", "", ""],
            MENGHI_RITA: ["MENGHI RITA", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            MESSANA_CRISTINA: ["MESSANA CRISTINA", "3A", "2A", "2A", "", "", "", "", "", "", "", "", "", "", "", "1B", "1T", "", "", "3A", "3A", "", "", "", "1B", "1B", "3A", "2A", "", "2A", "", "1B", "1D", "", "", ""],
            MIRABILE_FABRIZIO: ["MIRABILE FABRIZIO", "", "", "4P", "4P", "4N", "4N", "", "", "", "4N", "", "4P", "", "", "4N", "4N", "4N", "4N", "", "", "", "", "", "4P", "4P", "4N", "4N", "", "4P", "4P", "", "", "4P", "4P", ""],
            NASTO_MONIA: ["NASTO MONIA", "4A", "3A", "1N", "", "2A", "1A", "1B", "1A", "", "5A", "1N", "", "1B", "", "", "", "", "", "5A", "2A", "3A", "4A", "1A", "2A", "", "", "", "", "5A", "4A", "3A", "1B", "1N", ""],
            NUCIFORA_CLAUDIO: ["NUCIFORA CLAUDIO", "", "", "", "", "1N", "2L", "2N", "2L", "2L", "2I", "2P", "", "2N", "", "2L", "", "2I", "2D", "1D", "1P", "1N", "2I", "", "1P", "", "", "", "", "", "", "", "2I", "2D", "2P", "1D"],
            OSSO_ELVIRA: ["OSSO ELVIRA", "", "", "", "", "", "", "", "", "", "1N", "2N", "1B", "1D", "", "", "", "", "", "", "", "", "", "1A", "2A", "", "2D", "", "", "", "", "2P", "1P", "", "", ""],
            PALLINI_SIMONE: ["PALLINI SIMONE", "", "1L", "5I", "5L", "", "1T", "1J", "1L", "2I", "5I", "2L", "1I", "1J", "", "1I", "1V", "", "", "", "", "", "5L", "5L", "2L", "5I", "2I", "", "", "1V", "1T", "", "", "", "", ""],
            PAPANDREA_MARIA_CRISTINA: ["PAPANDREA MARIA CRISTINA", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            PETITO_FRANCESCO: ["PETITO FRANCESCO", "", "", "3A", "2DN", "5P", "5D", "3D", "", "", "", "1A", "2A", "4P", "", "1D", "5I", "3P", "", "3L", "2L", "", "1L", "4A", "", "1P", "", "", "", "", "", "2P", "", "5A", ""],
            PETRELLA_GIULIA: ["PETRELLA GIULIA", "", "", "4J", "2J", "", "3J", "", "3J", "5J", "1J", "", "", "", "", "", "", "", "", "5J", "4J", "3J", "", "", "4J", "1J", "2J", "5J", "", "", "", "2J", "", "1J", "", ""],
            POMINELLI_ANGELA: ["POMINELLI ANGELA", "2I", "2I", "5L", "", "1L", "", "", "2I", "", "1L", "", "", "", "", "3I", "5L", "5L", "2I", "2I", "", "", "", "", "", "2I", "", "3I", "", "3I", "3I", "2I", "5L", "1L", "", ""],
            POZZI_ACHILLE: ["POZZI ACHILLE", "", "5P", "", "", "1P", "", "", "4P", "2P", "3I", "1P", "5P", "", "", "2P", "2I", "4I", "4P", "", "", "", "2P", "2P", "5P", "", "4P", "4P", "", "1P", "1P", "", "", "", "", ""],
            QUERCIA_TERESA: ["QUERCIA TERESA", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "5I", "1L", "5T", "4T", "", "1L", "4T", "", "5T", "5I", "", "", "4T", "", "1L", "5I", "5T", ""],
            REDAELLI_ANNA: ["REDAELLI ANNA", "3T", "3T", "1S", "", "", "", "", "2S", "1S", "1S", "", "", "", "", "3T", "3T", "2S", "2S", "", "", "", "2S", "1S", "1S", "3T", "", "", "", "2S", "2S", "1S", "", "", "3T", ""],
            RINALDI_DAMIANO: ["RINALDI DAMIANO", "2J", "4T", "3T", "1J", "", "", "4J", "", "", "1V", "4T", "", "2T", "", "3J", "2J", "", "", "", "", "", "4J", "1T", "1J", "2T", "", "3T", "", "", "", "", "3J", "1T", "1V", ""],
            RUSSO_ENRICA: ["RUSSO ENRICA", "", "", "4I", "5I", "", "", "", "4I", "4I", "5L", "5L", "", "", "", "", "", "5I", "", "", "4L", "", "5I", "5I", "5L", "4L", "", "", "", "4I", "5L", "4L", "4L", "", "", ""],
            SANTAMBROGIO_ANNA: ["SANTAMBROGIO ANNA", "", "", "", "", "3A", "3I", "5A", "3I", "1D", "3A", "", "4A", "5A", "", "", "", "4A", "1I", "2DN", "", "", "", "", "", "4A", "1I", "3A", "", "D", "", "1I", "5A", "3I", ""],
            SAVINO_SARA: ["SAVINO SARA", "", "", "", "", "", "", "", "2A", "2A", "", "3A", "3A", "", "", "", "", "", "", "", "", "", "2A", "2A", "3A", "3A", "", "", "", "3A", "3A", "", "", "2A", "2A", ""],
            SCORTA_ANDREA: ["SCORTA ANDREA", "", "", "", "", "", "3A", "3A", "4A", "4A", "1B", "1B", "", "", "", "", "", "2A", "2A", "", "", "", "5D", "5D", "1D", "1D", "5A", "5A", "", "", "", "1A", "1A", "3D", "3D", ""],
            SCUFFI_GIUSEPPINA: ["SCUFFI GIUSEPPINA", "", "", "", "", "", "", "", "", "", "3L", "4L", "5L", "5I", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "5L", "3L", "4L", "5I", ""],
            SERRADORI_SILVIA: ["SERRADORI SILVIA", "5T", "5J", "", "", "", "", "", "4J", "4J", "3T", "3T", "3J", "3J", "", "5T", "5T", "5J", "5J", "5S", "", "", "4T", "4T", "3T", "4J", "", "3J", "", "5S", "5S", "4T", "", "", "", ""],
            SFERRAGATTA_MARIO: ["SFERRAGATTA MARIO", "2P", "2P", "D", "", "", "", "", "", "", "", "1V", "1V", "", "1S", "1S", "D", "", "5I", "5I", "1P", "", "", "", "", "", "", "", "D", "D", "1P", "", "2S", "2S", ""],
            SGHERZI_FEDERICA: ["SGHERZI FEDERICA", "4J", "4J", "3J", "", "", "", "", "", "", "", "4J", "5J", "5J", "", "5J", "4J", "4J", "", "3J", "3J", "", "3J", "3J", "", "5J", "5J", "4J", "", "5J", "3J", "", "", "", "", ""],
            SGRÒ_VINCENZO: ["SGRÒ VINCENZO", "1N", "1N", "", "1S", "", "1P", "2S", "", "", "", "", "", "", "", "1P", "1P", "", "", "", "", "", "1D", "1D", "", "2S", "1S", "1N", "", "", "", "", "", "", "", ""],
            SIMONE_MICHELE: ["SIMONE MICHELE", "", "", "", "", "4L", "1L", "", "3L", "3L", "D", "", "4L", "4L", "", "1L", "1L", "2L", "", "", "", "", "", "", "1L", "3L", "2L", "", "", "2L", "2L", "D", "", "3L", "4L", ""],
            SIRTORI_MADDALENA: ["SIRTORI MADDALENA", "", "", "1L", "1L", "2L", "2I", "", "", "", "", "", "", "", "", "", "", "2L", "4I", "4I", "", "", "2I", "", "3I", "3I", "", "", "", "", "", "", "", "", ""],
            SOLANO_EMANUELA: ["SOLANO EMANUELA", "", "", "", "", "", "", "", "2A", "2A", "", "3A", "3A", "", "", "", "1A", "", "1B", "2P", "", "2A", "", "", "", "1N", "", "2N", "1P", "", "", "", "", "", "", ""],
            TAGLIALATELA_IDA: ["TAGLIALATELA IDA", "5D", "3N", "3N", "4N", "", "", "", "", "", "", "4N", "3N", "5D", "", "", "3N", "5D", "5D", "", "4N", "4N", "3N", "4N", "5D", "", "", "", "", "", "", "4N", "3N", "5D", ""],
            TENTORI_CLARA: ["TENTORI CLARA", "", "4P", "5P", "5P", "", "3N", "3N", "3N", "3N", "", "4P", "", "", "", "", "", "", "5P", "5P", "", "", "", "", "", "", "", "", "", "", "", "", "5P", "5P", "5P", ""],
            TEOFILO_SILVIA: ["TEOFILO SILVIA", "", "", "1P", "1P", "", "4P", "4P", "2T", "2T", "4P", "", "", "", "", "2T", "", "1P", "1P", "4P", "", "", "1P", "1P", "2T", "", "", "", "", "2T", "2T", "4P", "4P", "", "", ""],
            TERRANA_ANGELA: ["TERRANA ANGELA", "5N", "4N", "4N", "3N", "", "1S", "", "1N", "1N", "2S", "2T", "", "", "", "5N", "5N", "1N", "", "", "", "", "", "", "1N", "4N", "", "3N", "", "3N", "3N", "4N", "1J", "", ""],
            TODDE_CLAUDIO: ["TODDE CLAUDIO", "3D", "3D", "", "5D", "5D", "", "", "5D", "5D", "", "", "", "", "", "", "1D", "1D", "", "3D", "3D", "", "3D", "3D", "3D", "5D", "5D", "", "", "5D", "5D", "2A", "", "", "", ""],
            TONIAL_MARICA: ["TONIAL MARICA", "", "", "4L", "4L", "5I", "5I", "", "", "1L", "", "5I", "4I", "4I", "", "4L", "4L", "", "", "", "", "", "1B", "1B", "4I", "4I", "4L", "", "", "1L", "1L", "5I", "5I", "4I", ""],
            VERGA_ELENA: ["VERGA ELENA", "", "", "", "5S", "5S", "5J", "5J", "", "", "3J", "3J", "", "", "", "4P", "4P", "", "1J", "1J", "2J", "2J", "", "", "", "", "5P", "5P", "", "3P", "3P", "4J", "4J", "", "", ""],
            VIOLA_ANGELA: ["VIOLA ANGELA", "1I", "1I", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            ZAPPA_ALESSANDRO: ["ZAPPA ALESSANDRO", "", "", "", "5N", "4P", "5P", "", "", "", "5N", "5N", "D", "", "", "", "", "", "3P", "", "5P", "5P", "5P", "4P", "D", "", "5N", "3P", "", "", "", "3P", "3P", "4P", "4P", ""],
            ZINGALES_SALVATORE: ["ZINGALES SALVATORE", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
            ZUCCARO_ADRIANO: ["ZUCCARO ADRIANO", "3P", "3P", "5A", "5A", "", "", "", "3P", "3P", "", "", "2P", "2P", "", "5A", "5A", "", "", "", "", "", "5A", "5A", "3P", "3P", "2P", "2P", "", "2P", "2P", "", "", "", "", ""],
            ZUCCONELLI_MARISA: ["ZUCCONELLI MARISA", "", "UT", "UT", "UT", "UT", "", "", "", "UT", "UT", "UT", "", "", "", "", "UT", "UT", "UT", "UT", "", "", "", "UT", "UT", "UT", "", "", "", "", "UT", "UT", "UT", "UT", "", ""],
        };

        const TEACHERS = Object.keys(TEACHER_SCHEDULE_DATA).map(key => key.replace(/_/g, ' '));
        const DAYS = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì"];
        const HOURS = ["8:00-8:50", "8:50-9:45", "9:55-10:50", "10:50-11:50", "11:50-12:45", "13:00-13:50", "13:50-14:40"];
        const INTERVAL_HOURS = {
            'I1': { index: 1, time: '9:45 - 9:55', triggers: 1 }, // L'intervallo 1 segue la 2a ora (indice 1)
            'I2': { index: 4, time: '12:45 - 13:00', triggers: 4 } // L'intervallo 2 segue la 5a ora (indice 4)
        };
        const CLASS_DADA = ["3A", "4A", "5A", "3D", "5D", "1I", "2I", "3I", "4I", "5I", "1L", "2L", "3L", "4L", "5L", "3N", "4N", "5N", "3P", "4P", "5P"];
        const CLASS_NON_DADA = ["1P", "1V", "1A", "1B", "1T", "2T", "2J", "1J", "5S", "2S", "1S", "1D", "2DN", "1N", "2A", "2P", "4J", "3J", "3T", "4T", "5TN", "5J"];
        const ALL_CLASSES = [...new Set([...CLASS_DADA, ...CLASS_NON_DADA])];
        const FLOORS = ["PT", "1P", "2P"];
        const CORRIDORS = ["Atrio", "A", "B", "C", "D", "E"];
        const SURVEILLANCE_AREAS = [
            { floor: 'PT', corridor: 'Atrio', name: 'Atrio Piano Terra' },
            { floor: 'PT', corridor: 'A', name: 'Corridoio A Piano Terra' },
            { floor: 'PT', corridor: 'D', name: 'Corridoio D Piano Terra' },
            { floor: '1P', corridor: 'A', name: 'Corridoio A Primo Piano' },
            { floor: '1P', corridor: 'B', name: 'Corridoio B Primo Piano' },
            { floor: '1P', corridor: 'D', name: 'Corridoio D Primo Piano' },
            { floor: '1P', corridor: 'E', name: 'Corridoio E Primo Piano' },
            { floor: '2P', corridor: 'A', name: 'Corridoio A Secondo Piano' },
            { floor: '2P', corridor: 'B', name: 'Corridoio B Secondo Piano' },
            { floor: '2P', corridor: 'D', name: 'Corridoio D Secondo Piano' },
            { floor: '2P', corridor: 'E', name: 'Corridoio E Secondo Piano' },
        ];

        // Stato globale per i risultati e gli input utente
        let surveillanceResults = [];
        let classLocationData = initializeClassLocationData();

        function initializeClassLocationData() {
            // Inizializza con un set di dati di esempio che possono essere modificati dall'utente.
            const data = {};
            ALL_CLASSES.forEach(c => {
                data[c] = {};
                DAYS.forEach(d => {
                    const isDada = CLASS_DADA.includes(c);
                    data[c][d] = {
                        status: isDada ? 'DADA' : 'FISSA',
                        floor: isDada ? '1P' : 'PT',
                        corridor: isDada ? (c.includes('I') ? 'B' : 'A') : (c.includes('P') ? 'A' : 'D'),
                        room: c + (isDada ? ' LAB' : ' 1'),
                    };
                });
            });
            return data;
        }

        // ====================================================================
        // GESTIONE UI INIZIALE E EVENTI
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            generateTeacherScheduleTable();
            generateClassLocationInput();
        });

        // 1. Genera la Tabella Orario Docenti (Modificabile)
        function generateTeacherScheduleTable() {
            const table = document.getElementById('teacher-schedule-table');
            let html = `<thead><tr><th>Docente</th>`;
            DAYS.forEach(day => {
                html += `<th colspan="${HOURS.length}" class="text-center bg-orange-100">${day}</th>`;
            });
            html += `</tr><tr><th></th>`;
            DAYS.forEach(() => {
                HOURS.forEach(hour => {
                    html += `<th class="text-xs font-normal text-gray-600">${hour.split('-')[0]}</th>`;
                });
            });
            html += `</tr></thead><tbody>`;

            for (const key in TEACHER_SCHEDULE_DATA) {
                const row = TEACHER_SCHEDULE_DATA[key];
                html += `<tr><td class="sticky left-0 bg-orange-50 font-medium">${row[0]}</td>`;
                for (let i = 1; i < row.length; i++) {
                    const value = row[i] || ''; // Sostituisce 'x' o vuoto con ''
                    html += `<td data-row="${key}" data-col="${i}" class="editable-cell cursor-pointer hover:bg-yellow-100 transition duration-100 text-center ${value ? 'bg-blue-50' : ''}">${value}</td>`;
                }
                html += `</tr>`;
            }

            html += `</tbody>`;
            table.innerHTML = html;
            addEditListeners();
        }

        // Aggiunge la logica per rendere l'orario modificabile
        function addEditListeners() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    if (this.querySelector('input')) return; // Evita di creare più input

                    const originalValue = this.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = originalValue;
                    input.className = 'w-full text-center border-b border-blue-500 focus:outline-none';

                    this.textContent = '';
                    this.appendChild(input);
                    input.focus();

                    // Gestione salvataggio (blur o invio)
                    const saveChange = () => {
                        const newValue = input.value.toUpperCase().trim();
                        const rowKey = this.dataset.row;
                        const colIndex = parseInt(this.dataset.col);

                        // Aggiorna la variabile globale
                        TEACHER_SCHEDULE_DATA[rowKey][colIndex] = newValue;
                        
                        this.textContent = newValue;
                        this.classList.toggle('bg-blue-50', !!newValue);
                        this.removeEventListener('click', saveChange);
                    };

                    input.addEventListener('blur', saveChange);
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveChange();
                        }
                    });
                });
            });
        }


        // 2. Genera la Sezione Input Aule/DADA
        function generateClassLocationInput() {
            const container = document.getElementById('class-location-input');
            let html = '';

            ALL_CLASSES.sort().forEach(className => {
                const isDada = CLASS_DADA.includes(className);
                const status = isDada ? 'DADA' : 'FISSA';

                html += `
                    <div class="p-3 bg-gray-100 rounded-lg shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-2">${className} <span class="text-xs px-2 py-0.5 rounded-full ${isDada ? 'bg-purple-200 text-purple-800' : 'bg-green-200 text-green-800'}">${status}</span></h4>
                        <div id="location-for-${className}" class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                            <label class="col-span-2 md:col-span-1">Aula
                                <input type="text" id="room-${className}" value="${classLocationData[className][DAYS[0]].room}" class="w-full mt-1 p-1 border rounded-md" onchange="updateClassLocation('${className}', 'room', this.value)">
                            </label>
                            <label class="col-span-1">Piano
                                <select id="floor-${className}" class="w-full mt-1 p-1 border rounded-md" onchange="updateClassLocation('${className}', 'floor', this.value)">
                                    ${FLOORS.map(f => `<option value="${f}" ${classLocationData[className][DAYS[0]].floor === f ? 'selected' : ''}>${f}</option>`).join('')}
                                </select>
                            </label>
                            <label class="col-span-1">Corridoio
                                <select id="corridor-${className}" class="w-full mt-1 p-1 border rounded-md" onchange="updateClassLocation('${className}', 'corridor', this.value)">
                                    ${CORRIDORS.map(c => `<option value="${c}" ${classLocationData[className][DAYS[0]].corridor === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </label>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-transparent">Giorno*</label>
                                <button onclick="toggleDailyInputs('${className}')" class="w-full bg-blue-500 text-white p-1 rounded-md text-xs hover:bg-blue-600 transition duration-150">
                                    Modifica per Giorno
                                </button>
                            </div>
                        </div>
                        <!-- Blocco per input giornaliero (nascosto di default) -->
                        <div id="daily-inputs-${className}" class="hidden mt-3 p-3 bg-white rounded-md border border-dashed border-gray-300">
                             ${DAYS.map(day => `
                                <div class="flex space-x-2 mb-2 items-center">
                                    <span class="w-16 font-medium text-gray-600">${day}</span>
                                    <select id="daily-floor-${className}-${day}" class="p-1 border rounded-md text-xs" onchange="updateClassLocationDaily('${className}', '${day}', 'floor', this.value)">
                                        ${FLOORS.map(f => `<option value="${f}" ${classLocationData[className][day].floor === f ? 'selected' : ''}>${f}</option>`).join('')}
                                    </select>
                                    <select id="daily-corridor-${className}-${day}" class="p-1 border rounded-md text-xs" onchange="updateClassLocationDaily('${className}', '${day}', 'corridor', this.value)">
                                        ${CORRIDORS.map(c => `<option value="${c}" ${classLocationData[className][day].corridor === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                    <input type="text" id="daily-room-${className}-${day}" value="${classLocationData[className][day].room}" class="p-1 border rounded-md text-xs flex-grow" onchange="updateClassLocationDaily('${className}', '${day}', 'room', this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.updateClassLocation = (className, field, value) => {
            // Aggiorna tutti i giorni con lo stesso valore per il campo specificato
            DAYS.forEach(day => {
                classLocationData[className][day][field] = value.toUpperCase();
                // Sincronizza anche gli input giornalieri se visibili
                const dailyInput = document.getElementById(`daily-${field}-${className}-${day}`);
                if (dailyInput) dailyInput.value = value.toUpperCase();
            });
            console.log(`Posizione predefinita per ${className} aggiornata: ${field} = ${value}`);
        };

        window.updateClassLocationDaily = (className, day, field, value) => {
            // Aggiorna solo il giorno specifico
            classLocationData[className][day][field] = value.toUpperCase();
            console.log(`Posizione giornaliera per ${className} (${day}) aggiornata: ${field} = ${value}`);
        };

        window.toggleDailyInputs = (className) => {
            const dailyBlock = document.getElementById(`daily-inputs-${className}`);
            dailyBlock.classList.toggle('hidden');
        };

        // ====================================================================
        // LOGICA DI CALCOLO AVANZATO
        // ====================================================================

        window.startCalculation = () => {
            document.getElementById('start-calc-btn').disabled = true;
            document.getElementById('download-pdf-btn').disabled = true;
            document.getElementById('surveillance-results').innerHTML = '<p class="text-center text-blue-500 mt-10"><i class="fas fa-spinner fa-spin"></i> Avvio Calcolo Incrociato...</p>';
            
            // Simula un avanzamento (il calcolo è veloce, ma la simulazione dà feedback)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 20;
                document.getElementById('progress-indicator').textContent = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    performAdvancedCalculation();
                }
            }, 100);
        };

        /**
         * Esegue l'analisi incrociata per assegnare le sorveglianze.
         * Criterio: Il docente che ha la classe immediatamente prima dell'intervallo
         * nel corridoio da sorvegliare, ha la precedenza. Max 2 per corridoio.
         */
        function performAdvancedCalculation() {
            surveillanceResults = [];
            const teacherLoad = {};
            const assignedSurveillances = {};

            // 1. Inizializza il conteggio del carico per ogni docente
            TEACHERS.forEach(t => teacherLoad[t] = 0);

            // 2. Itera su ogni giorno e ogni area di sorveglianza
            DAYS.forEach((day, dayIndex) => {
                SURVEILLANCE_AREAS.forEach(area => {
                    const areaKey = `${area.floor}-${area.corridor}`;

                    // Inizializza i risultati per l'area
                    if (!assignedSurveillances[areaKey]) assignedSurveillances[areaKey] = { I1: [], I2: [] };

                    // 3. Calcola assegnazioni per INTERVALLO 1 (dopo 2a ora, indice 1)
                    assignSurveillance(day, dayIndex, 'I1', area, areaKey, teacherLoad);

                    // 4. Calcola assegnazioni per INTERVALLO 2 (dopo 5a ora, indice 4)
                    assignSurveillance(day, dayIndex, 'I2', area, areaKey, teacherLoad);
                });
            });

            // 5. Raggruppa i risultati finali per Giorno, Intervallo e Area
            groupFinalResults();
            displayResults();
            updateStats(teacherLoad);
            
            document.getElementById('start-calc-btn').disabled = false;
            document.getElementById('download-pdf-btn').disabled = false;
            document.getElementById('progress-indicator').textContent = '100%';
        }

        function assignSurveillance(day, dayIndex, interval, area, areaKey, teacherLoad) {
            const hourIndex = INTERVAL_HOURS[interval].triggers;
            const dayOffset = 1 + dayIndex * HOURS.length;
            const classHourIndex = dayOffset + hourIndex;

            // Docenti già assegnati per questo intervallo/area
            let assignedCount = 0;
            const alreadyAssignedTeachers = new Set();
            
            // Crea una lista di potenziali candidati per l'area
            const candidates = [];

            for (const teacherKey in TEACHER_SCHEDULE_DATA) {
                const teacherName = TEACHER_SCHEDULE_DATA[teacherKey][0];
                const classAssigned = TEACHER_SCHEDULE_DATA[teacherKey][classHourIndex] || '';

                if (classAssigned && classAssigned !== 'D' && classAssigned !== 'UT') {
                    const classLoc = classLocationData[classAssigned]?.[day];

                    if (classLoc && classLoc.floor === area.floor && classLoc.corridor === area.corridor) {
                        // Criterio di precedenza: docenti con carico minore
                        candidates.push({
                            teacherName,
                            classAssigned,
                            load: teacherLoad[teacherName],
                            key: teacherKey // Per evitare duplicati nel Set
                        });
                    }
                }
            }

            // Ordina i candidati per carico crescente (meno carico = più probabile)
            candidates.sort((a, b) => a.load - b.load);

            // Assegna fino a 2 docenti
            candidates.forEach(candidate => {
                if (assignedCount < 2 && !alreadyAssignedTeachers.has(candidate.teacherName)) {
                    surveillanceResults.push({
                        day,
                        interval,
                        areaKey,
                        floor: area.floor,
                        corridor: area.corridor,
                        teacher: candidate.teacherName,
                        classRef: candidate.classAssigned // Classe che ha generato l'assegnazione
                    });
                    teacherLoad[candidate.teacherName]++;
                    alreadyAssignedTeachers.add(candidate.teacherName);
                    assignedCount++;
                }
            });

            // Se ci sono meno di 2 assegnazioni, aggiungi un placeholder 'NON ASSEGNATO'
            while (assignedCount < 2) {
                 surveillanceResults.push({
                    day,
                    interval,
                    areaKey,
                    floor: area.floor,
                    corridor: area.corridor,
                    teacher: assignedCount === 0 ? 'NON ASSEGNATO' : 'NON NECESSARIO',
                    classRef: ''
                });
                assignedCount++;
            }
        }


        // 6. Raggruppa i risultati finali in un formato più leggibile
        function groupFinalResults() {
            const grouped = {};
            surveillanceResults.forEach(res => {
                if (!grouped[res.day]) grouped[res.day] = {};
                if (!grouped[res.day][res.interval]) grouped[res.day][res.interval] = {};
                if (!grouped[res.day][res.interval][res.areaKey]) grouped[res.day][res.interval][res.areaKey] = [];
                grouped[res.day][res.interval][res.areaKey].push(res);
            });
            return grouped;
        }


        // 7. Aggiorna le statistiche e la UI
        function updateStats(teacherLoad) {
            const totalAssigned = surveillanceResults.filter(r => r.teacher !== 'NON ASSEGNATO' && r.teacher !== 'NON NECESSARIO').length;
            const involvedTeachers = new Set(surveillanceResults.filter(r => r.teacher !== 'NON ASSEGNATO' && r.teacher !== 'NON NECESSARIO').map(r => r.teacher)).size;

            document.getElementById('total-sorveglianze').textContent = totalAssigned;
            document.getElementById('involved-teachers').textContent = involvedTeachers;
        }

        // 8. Visualizza i risultati
        function displayResults() {
            const container = document.getElementById('surveillance-results');
            const grouped = groupFinalResults();
            let html = '';
            
            const filterValue = document.getElementById('smart-filter').value;
            let totalFilteredSurveillances = 0;

            DAYS.forEach(day => {
                html += `<div class="day-result mb-6 p-4 rounded-xl shadow-md bg-white border-t-4 border-blue-500" data-day="${day}">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">${day}</h3>`;

                const dayData = grouped[day] || {};
                
                Object.keys(INTERVAL_HOURS).forEach(intervalKey => {
                    const intervalTime = INTERVAL_HOURS[intervalKey].time;
                    const intervalData = dayData[intervalKey] || {};

                    html += `<div class="interval-block mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Intervallo ${intervalKey} (${intervalTime})</h4>
                        <table class="data-table w-full text-sm">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="w-1/4">Area</th>
                                    <th class="w-3/4">Docenti Assegnati (Max 2)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    SURVEILLANCE_AREAS.map(a => `${a.floor}-${a.corridor}`).forEach(areaKey => {
                        const assignments = intervalData[areaKey] || [];
                        const assignedTeachers = assignments.filter(r => r.teacher !== 'NON ASSEGNATO' && r.teacher !== 'NON NECESSARIO');
                        const status = assignments.filter(r => r.teacher === 'NON ASSEGNATO').length > 0 ? 'unassigned' : (assignedTeachers.length === 1 ? 'one-teacher' : 'ok');

                        // Applicazione Filtro Intelligente
                        let isVisible = true;
                        if (filterValue === 'needs-two' && assignedTeachers.length !== 1) isVisible = false;
                        if (filterValue === 'unassigned' && assignedTeachers.length > 0) isVisible = false;

                        if (isVisible) {
                            totalFilteredSurveillances++;
                            const teachersList = assignments.map(a => {
                                if (a.teacher === 'NON ASSEGNATO') {
                                    return `<span class="font-bold text-red-600">NON ASSEGNATO</span>`;
                                }
                                if (a.teacher === 'NON NECESSARIO') {
                                    return `<span class="text-gray-400">Non Richiesto</span>`;
                                }
                                return `${a.teacher} (Rif. Classe: ${a.classRef})`;
                            }).join('<br>');

                            let rowClass = '';
                            if (status === 'unassigned') rowClass = 'bg-red-100 border-l-4 border-red-500';
                            if (status === 'one-teacher') rowClass = 'bg-yellow-100 border-l-4 border-yellow-500';

                            html += `<tr class="${rowClass}">
                                <td>${SURVEILLANCE_AREAS.find(a => `${a.floor}-${a.corridor}` === areaKey).name}</td>
                                <td>${teachersList}</td>
                            </tr>`;
                        }
                    });

                    html += `</tbody></table></div>`;
                });
                html += `</div>`;
            });

            if (totalFilteredSurveillances === 0 && filterValue !== 'all') {
                container.innerHTML = `<p class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-lg">Nessun risultato trovato per il filtro selezionato. Torna a 'Tutti i Risultati' o modifica i dati di input.</p>`;
            } else if (surveillanceResults.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 mt-10">Inserisci la configurazione delle aule e clicca su "Avvia Calcolo" per generare il piano di sorveglianza.</p>`;
            } else {
                container.innerHTML = html;
            }
        }

        window.filterResults = displayResults;

        // ====================================================================
        // GESTIONE DOWNLOAD PDF
        // ====================================================================
        window.downloadPDF = () => {
            if (!surveillanceResults.length) {
                console.error("Nessun dato di sorveglianza da scaricare.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            doc.setFontSize(18);
            doc.text("Piano Giornaliero di Sorveglianza Intervalli", 148.5, 20, { align: "center" });
            doc.setFontSize(10);
            doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')} | Referente: Marisa Zucconelli`, 148.5, 25, { align: "center" });

            const grouped = groupFinalResults();
            let finalData = [];
            let startY = 30;

            DAYS.forEach(day => {
                const dayData = grouped[day] || {};
                
                Object.keys(INTERVAL_HOURS).forEach(intervalKey => {
                    const intervalTime = INTERVAL_HOURS[intervalKey].time;
                    const intervalData = dayData[intervalKey] || {};
                    
                    SURVEILLANCE_AREAS.map(a => `${a.floor}-${a.corridor}`).forEach(areaKey => {
                        const areaName = SURVEILLANCE_AREAS.find(a => `${a.floor}-${a.corridor}` === areaKey).name;
                        const assignments = intervalData[areaKey] || [];
                        
                        const teachers = assignments.map(a => {
                            if (a.teacher === 'NON ASSEGNATO') return 'NON ASSEGNATO';
                            if (a.teacher === 'NON NECESSARIO') return '---';
                            return `${a.teacher} (Rif. ${a.classRef})`;
                        }).join(' / ');

                        // Aggiungi alla struttura per autoTable
                        finalData.push([
                            day,
                            intervalKey,
                            intervalTime,
                            areaName,
                            teachers
                        ]);
                    });
                });
            });

            doc.autoTable({
                startY: startY,
                head: [['Giorno', 'Intervallo', 'Orario', 'Area di Sorveglianza', 'Docenti Assegnati']],
                body: finalData,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }, // Tailwind blue-500
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 50 },
                },
                didParseCell: (data) => {
                    // Evidenziazione nel PDF
                    if (data.column.index === 4 && data.cell.text.includes('NON ASSEGNATO')) {
                        data.cell.styles.fillColor = [255, 200, 200]; // Rosso chiaro
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            doc.save('Piano_Sorveglianze_Scolastiche.pdf');
        };

        // Rende le funzioni globali accessibili dall'HTML
        window.startCalculation = startCalculation;
        window.updateClassLocation = updateClassLocation;
        window.updateClassLocationDaily = updateClassLocationDaily;
        window.toggleDailyInputs = toggleDailyInputs;
        window.filterResults = filterResults;
        window.downloadPDF = downloadPDF;
    </script>
</body>
</html>
